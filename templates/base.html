<!DOCTYPE html>
<html data-theme="dark">
<head>
    <title>StudySync</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');</script>
</head>
<body>
    <nav>
        <a href="/" style="text-decoration: none; font-size: 1.5rem; font-weight: bold; color: var(--text-color);">StudySync</a>
        <div style="display: flex; gap: 15px; align-items: center;">
            {% if user %}
                <span style="color: var(--text-color);">{{ user.username }}</span>
                <a href="/logout" class="nav-item" title="Logout" style="padding: 8px 12px; font-size: 1.2rem;">âŠ—</a>
            {% endif %}
        </div>
    </nav>
    <div class="container">{% block content %}{% endblock %}</div>
    <div id="notification-toast"></div>

    <script>
        // Define showLoader function globally
        function showLoader(duration) {
            console.log('[base] showLoader called for', duration, 'ms');
            // Create a simple loader overlay if it doesn't exist
            let loader = document.getElementById('page-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'page-loader';
                loader.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.3); display: flex; align-items: center;
                    justify-content: center; z-index: 9999; font-size: 2rem;
                `;
                loader.innerText = 'â³';
                document.body.appendChild(loader);
            }
            loader.style.display = 'flex';
            if (duration > 0) {
                setTimeout(() => {
                    loader.style.display = 'none';
                }, duration);
            }
        }

        function toggleTheme() {
            const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }
        const socket = io();
        const gid = window.location.pathname.split('/').pop();
        if (gid && window.location.pathname.includes('/group/')) socket.emit('join', {group_id: gid});
        socket.on('notification', d => {
            const t = document.getElementById('notification-toast');
            // Support legacy 'msg' and new {username, topic}
            t.innerText = d.msg ? d.msg : `ðŸ”¥ ${d.username} finished: ${d.topic}!`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 4000);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // If we landed on a group page, show loader (entering a room)
            if (window.location.pathname.startsWith('/group/')) {
                showLoader(5000);
            }
        });
    </script>
</body>
    <footer style="position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 0.8rem; color: #888;">
        made by the powers that be
    </footer>
</html>