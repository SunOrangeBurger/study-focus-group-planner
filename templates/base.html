<!DOCTYPE html>
<html data-theme="dark">
<head>
    <title>StudySync</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');</script>
</head>
<body>
    <nav>
        <a href="/" style="text-decoration: none; font-size: 1.5rem; font-weight: bold; color: var(--text-color);">StudySync</a>
        <div style="display: flex; gap: 15px; align-items: center;">
            {% if user %}
                <span style="color: var(--text-color);">{{ user.username }}</span>
                <a href="/logout" class="nav-item" title="Logout" style="padding: 8px 12px; font-size: 1.2rem;">âŠ—</a>
            {% endif %}
        </div>
    </nav>
    <div class="container">{% block content %}{% endblock %}</div>
    <div id="notification-toast"></div>

    <script>
        function toggleTheme() {
            const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }
        const socket = io();
        const gid = window.location.pathname.split('/').pop();
        if (gid && window.location.pathname.includes('/group/')) socket.emit('join', {group_id: gid});
        socket.on('notification', d => {
            const t = document.getElementById('notification-toast');
            // Support legacy 'msg' and new {username, topic}
            t.innerText = d.msg ? d.msg : `ðŸ”¥ ${d.username} finished: ${d.topic}!`;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 4000);
        });

        document.addEventListener('DOMContentLoaded', () => {
            // If we landed on a group page, show loader (entering a room)
            if (window.location.pathname.startsWith('/group/')) {
                showLoader(5000);
            }

            // Intercept Create Group anchor clicks to show loader before navigation
            document.querySelectorAll('a[href="/create-group"]').forEach(a => {
                a.addEventListener('click', e => {
                    e.preventDefault();
                    showLoader(5000);
                    setTimeout(() => window.location.href = a.href, 5000);
                });
            });

            // Intercept Join Group forms to show loader before submit
            document.querySelectorAll('form[action="/join-group"]').forEach(f => {
                f.addEventListener('submit', e => {
                    e.preventDefault();
                    showLoader(5000);
                    setTimeout(() => f.submit(), 5000);
                });
            });
        });
    </script>
</body>
    <footer style="position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 0.8rem; color: #888;">
        made by the powers that be
    </footer>
</html>