{% extends 'base.html' %}
{% block content %}
<div class="card" style="max-width: 700px; margin: auto;">
    <h1>Create Study Group</h1>
    <input type="text" id="gname" placeholder="Group Name" style="font-size: 1.5rem; margin-bottom: 20px;">
    
    <div id="subs"></div>
    
    <!-- Styled as a clear action button -->
    <button type="button" id="add-sub-btn" class="nav-item" style="width: 100%; margin: 10px 0; cursor: pointer; text-align: center;">
        + Add Subject
    </button>
    
    <button type="button" id="save-btn" class="btn-main" style="margin-top: 20px; width: 100%;">
        Create Group
    </button>
</div>

<script>
    function addSub() {
        console.log('addSub() called');
        const id = Date.now();
        const h = `<div class="card sub" id="${id}" style="border-left: 4px solid var(--accent-color); margin-top: 20px;">
            <input type="text" class="s-name" placeholder="Subject Name (e.g., Mathematics)">
            <div class="units"></div>
            <button type="button" class="nav-item add-unit-btn" data-sid="${id}" style="font-size: 0.8rem; cursor: pointer; margin-top: 10px;">
                + Add Unit
            </button>
        </div>`;
        document.getElementById('subs').insertAdjacentHTML('beforeend', h);
    }

    function addU(sid) {
        console.log('addU() called with sid:', sid);
        const c = document.getElementById(sid).querySelector('.units');
        const h = `<div class="u-box" style="margin: 15px 0 10px 20px; padding: 15px; background: rgba(124, 77, 255, 0.05); border-radius: 8px; border: 1px solid var(--border-color);">
            <input type="text" class="u-name" placeholder="Unit Title (e.g., Calculus)">
            <input type="text" class="u-concepts" placeholder="Concepts (comma separated: Limits, Derivatives, Integrals)">
        </div>`;
        c.insertAdjacentHTML('beforeend', h);
    }

    function save() {
        console.log('save() invoked');
        const syllabus = [];
        const saveBtn = document.getElementById('save-btn');
        const groupName = document.getElementById('gname').value.trim();
        
        if(!groupName) { alert("Please enter a group name"); return; }

        document.querySelectorAll('.sub').forEach(s => {
            const units = [];
            s.querySelectorAll('.u-box').forEach((u, i) => {
                const conceptVal = u.querySelector('.u-concepts').value;
                units.push({
                    unit_number: i+1, 
                    unit_name: u.querySelector('.u-name').value, 
                    concepts: conceptVal ? conceptVal.split(',').map(x => x.trim()) : []
                });
            });
            syllabus.push({subject_name: s.querySelector('.s-name').value, units: units});
        });

        saveBtn.disabled = true;
        saveBtn.textContent = 'Creating...';
        showLoader(10000);

        fetch('/create-group', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: groupName, syllabus: syllabus})
        }).then(res => {
            console.log('Response status:', res.status);
            if (!res.ok) throw new Error('Create failed with status ' + res.status);
            return res.json();
        }).then(data => {
            console.log('Success response:', data);
            window.location.href = '/';
        }).catch(err => {
            console.error('create-group error', err);
            alert('Could not create group — check console for details');
            saveBtn.disabled = false;
            saveBtn.textContent = 'Create Group';
            document.getElementById('page-loader').style.display = 'none';
        });
    }

    function attachCreateGroupHandlers() {
        console.log('[creategroup] Attaching handlers');
        const addSubBtn = document.getElementById('add-sub-btn');
        const saveBtn = document.getElementById('save-btn');
        const subs = document.getElementById('subs');

        if (addSubBtn) {
            addSubBtn.addEventListener('click', addSub);
            console.log('[creategroup] ✓ add-sub-btn handler attached');
        }
        if (saveBtn) {
            saveBtn.addEventListener('click', save);
            console.log('[creategroup] ✓ save-btn handler attached');
        }
        if (subs) {
            subs.addEventListener('click', e => {
                const btn = e.target.closest('.add-unit-btn');
                if (btn) {
                    const sid = btn.getAttribute('data-sid');
                    addU(sid);
                }
            });
            console.log('[creategroup] ✓ delegation listener attached to subs');
        }
    }

    // Attach handlers
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachCreateGroupHandlers);
    } else {
        attachCreateGroupHandlers();
    }
</script>
{% endblock %}